---
title: "Stat 147 Assignment 4"
author:
- name: Marc Shervin Ignacio
  affiliation: "2019-04690"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    theme: lumen
    toc: yes
    toc_float: yes
    toc_depth: 4
    number_sections: no
    highlight: pygments
    fig_caption: yes
    code_folding: show
editor_options:
  markdown:
    wrap: 72
---
```{r}
library(psych)
library("GPArotation")
library("readxl")
library(knitr)
library(kableExtra)
```

```{r, echo=FALSE}
show_table <- function(x,text=NULL){
  x %>%
  kbl(caption=text) %>%
  kable_classic(full_width = F, html_font = "Cambria")
}
```


```{r}
vitamin <- read_xlsx("vitamins example data.xlsx")
vitamin %>%
  show_table("Dataset")
```

Kaiser-Meyer-Olkin Measure of Sampling Adequacy
```{r}
psych::KMO(r = vitamin)
```

Test for Sphericity
```{r}
psych::cortest.bartlett(R = cor(vitamin), n = 300)
```

EFA Section

```{r}
library(nFactors)
ev <- eigen(cor(vitamin)) # get eigenvalues
ap <- parallel(subject=nrow(vitamin),var=ncol(vitamin),
  rep=100,cent=.05)
nS <- nScree(x=ev$values, aparallel=ap$eigen$qevpea)
plotnScree(nS)
```


```{r}
fa_4varimax <- psych::fa(r = vitamin,
nfactors = 4,
rotate = "varimax",
scores = "regression",
SMC = T,
fm = "pa")

fa_4quartimax <- psych::fa(r = vitamin,
nfactors = 4,
rotate = "quartimax",
scores = "regression",
SMC = T,
fm = "pa")

fa_4oblimin <- psych::fa(r = vitamin,
nfactors = 4,
rotate = "oblimin",
scores = "regression",
SMC = T,
fm = "pa")

```

```{r}
fa.diagram(fa_4varimax)
fa.diagram(fa_4quartimax)
fa.diagram(fa_4oblimin)
```
```{r}
fa.sort(fa_4varimax$loadings)
```
```{r,collapse=TRUE}
fa_4varimax_sorted <- fa.sort(fa_4varimax$loadings) 
loading_matrix <- as.data.frame((matrix(fa_4varimax_sorted, ncol = 4, nrow = 23, 
                         dimnames = list(NULL,colnames(fa_4varimax_sorted)))))
loading_matrix <- cbind(loading_matrix,Test = rownames(fa_4varimax_sorted))
```
```{r,collapse=TRUE}
loadings_melted <- reshape2::melt(loading_matrix, id="Test",
                                  measure=c("PA1", "PA4", "PA2", "PA3"),
                                  variable.name="Factor", value.name="Loading")
```
```{r,collapse=TRUE}
positions <- rev(rownames(fa_4varimax_sorted))

ggplot(loadings_melted, aes(Test, abs(Loading), fill=Loading)) + 
  facet_wrap(~ Factor, nrow=1) + #place the factors in separate facets
  geom_bar(stat="identity") + #make the bars
  coord_flip() + #flip the axes so the test names can be horizontal  
  #define the fill color gradient: blue=positive, red=negative
  scale_fill_gradient2(name = "Loading", 
                       high = "blue", mid = "white", low = "red", 
                       midpoint=0, guide=F) +
  scale_x_discrete(limits = positions) +
  xlab("Variables") +
  ylab("Loading Strength") + #improve y-axis label
  theme_bw(base_size=10)
```

```{r,collapse=TRUE}
fa_4quartimax_sorted <- fa.sort(fa_4quartimax$loadings) 
loading_matrix <- as.data.frame((matrix(fa_4quartimax_sorted, ncol = 4, nrow = 23, 
                         dimnames = list(NULL,colnames(fa_4quartimax_sorted)))))
loading_matrix <- cbind(loading_matrix,Test = rownames(fa_4quartimax_sorted))
```
```{r,collapse=TRUE}
loadings_melted <- reshape2::melt(loading_matrix, id="Test",
                                  measure=c("PA1", "PA4", "PA2", "PA3"),
                                  variable.name="Factor", value.name="Loading")
```
```{r,collapse=TRUE}
positions <- rev(rownames(fa_4quartimax_sorted))

ggplot(loadings_melted, aes(Test, abs(Loading), fill=Loading)) + 
  facet_wrap(~ Factor, nrow=1) + #place the factors in separate facets
  geom_bar(stat="identity") + #make the bars
  coord_flip() + #flip the axes so the test names can be horizontal  
  #define the fill color gradient: blue=positive, red=negative
  scale_fill_gradient2(name = "Loading", 
                       high = "blue", mid = "white", low = "red", 
                       midpoint=0, guide=F) +
  scale_x_discrete(limits = positions) +
  
  xlab("Variables") +
  ylab("Loading Strength") + #improve y-axis label
  theme_bw(base_size=10)
```
```{r,collapse=TRUE}
fa_4oblimin_sorted <- fa.sort(fa_4oblimin$loadings) 
loading_matrix <- as.data.frame((matrix(fa_4oblimin_sorted, ncol = 4, nrow = 23, 
                         dimnames = list(NULL,colnames(fa_4oblimin_sorted)))))
loading_matrix <- cbind(loading_matrix,Test = rownames(fa_4oblimin_sorted))
```
```{r,collapse=TRUE}
loadings_melted <- reshape2::melt(loading_matrix, id="Test",
                                  measure=c("PA1", "PA4", "PA2", "PA3"),
                                  variable.name="Factor", value.name="Loading")
```
```{r,collapse=TRUE}
positions <- rev(rownames(fa_4oblimin_sorted))

ggplot(loadings_melted, aes(Test, abs(Loading), fill=Loading)) + 
  facet_wrap(~ Factor, nrow=1) + #place the factors in separate facets
  geom_bar(stat="identity") + #make the bars
  coord_flip() + #flip the axes so the test names can be horizontal  
  #define the fill color gradient: blue=positive, red=negative
  scale_fill_gradient2(name = "Loading", 
                       high = "blue", mid = "white", low = "red", 
                       midpoint=0, guide=F) +
  scale_x_discrete(limits = positions) +
  
  xlab("Variables") +
  ylab("Loading Strength") + #improve y-axis label
  theme_bw(base_size=10)
```


